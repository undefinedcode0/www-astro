---
// No server-side logic needed here anymore

// Define constants used by both the template and the script
const validFonts = ['sans', 'serif', 'mono'] as const;
type FontType = (typeof validFonts)[number];
const defaultFont = 'serif' as FontType; // Ensure this matches Layout.astro head script
const fontDefinitions: { name: FontType; label: string; class: string }[] = [
  { name: 'serif', label: 'Serif', class: 'font-serif' },
  { name: 'sans', label: 'Sans', class: 'font-sans' },
  { name: 'mono', label: 'Mono', class: 'font-mono' },
];
// Create the map for easy class lookup, ensure this matches Layout.astro head script
const fontClassMap: Record<FontType, string> = {
  sans: 'font-sans',
  serif: 'font-serif',
  mono: 'font-mono',
};
---

<div id="font-selector" class="flex p-1 space-x-1 rounded-xl bg-text/10 w-fit shadow-md">
  {
    fontDefinitions.map(({ name, label, class: className }) => (
      <button
        data-font={name}
        title={`Set font to ${label}`}
        class:list={[
          'font-button px-3 py-1 text-sm text-text smooth-md rounded-lg',
          // Initial active state (e.g., 'bg-bg') will be added by the script below
          className, // Apply the font class directly to the button text
        ]}>
        {label}
      </button>
    ))
  }
</div>

<script is:inline define:vars={{ validFonts, defaultFont, fontClassMap }}>
  const fontStorageKey = 'font';

  function getStoredFont() {
    const stored = localStorage.getItem(fontStorageKey);
    return validFonts.includes(stored) ? stored : defaultFont;
  }

  function applyFontPreference(font) {
    const d = document.documentElement;
    Object.values(fontClassMap).forEach((cls) => d.classList.remove(cls));
    d.classList.add(fontClassMap[font] || fontClassMap[defaultFont]);
  }

  function updateButtons(selectedFont) {
    document.querySelectorAll('#font-selector .font-button').forEach((button) => {
      const buttonFont = button.getAttribute('data-font');
      const isActive = buttonFont === selectedFont;
      button.classList.toggle('bg-bg', isActive);
      button.classList.toggle('hover:bg-text/10', !isActive);
    });
  }

  function setFont(newFont) {
    if (!validFonts.includes(newFont)) return;
    localStorage.setItem(fontStorageKey, newFont);
    applyFontPreference(newFont);
    updateButtons(newFont);
  }

  function initFontSelector() {
    const root = document.getElementById('font-selector');
    if (!root) return;

    root.onclick = (e) => {
      const btn = e.target.closest?.('button[data-font]');
      if (!btn) return;
      const newFont = btn.getAttribute('data-font');
      if (newFont) setFont(newFont);
    };

    const current = getStoredFont();
    updateButtons(current);
  }

  initFontSelector();
  document.addEventListener('astro:page-load', initFontSelector);
</script>

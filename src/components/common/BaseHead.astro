---
import Aside from '@/components/common/Aside.astro';
import BaseHead from '@/components/common/BaseHead.astro';
import Footer from '@/components/common/Footer.astro';
import Header from '@/components/common/Header.astro';

interface Props {
  title: string;
  description: string;
  dim?: boolean;
  class?: string;
}
const { title, description, dim: isDim, class: classList } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead {title} {description} />
    
    <!-- Blocking Theme & Font Initialization (prevents FOUC) -->
    <script is:inline>
      (function () {
        const d = document.documentElement;

        // Theme
        const themeKey = 'theme';
        const defaultTheme = 'system';
        const darkQuery = window.matchMedia('(prefers-color-scheme: dark)');

        function applyTheme(theme) {
          d.classList.remove('dark', 'light', 'system');
          d.classList.add(theme);
          if (theme === 'system') {
            d.classList.toggle('dark', darkQuery.matches);
          } else if (theme === 'dark') {
            d.classList.add('dark');
          }
        }

        // Font
        const fontKey = 'font';
        const fontMap = { sans: 'font-sans', serif: 'font-serif', mono: 'font-mono' };
        const defaultFont = 'serif';

        function applyFont(font) {
          Object.values(fontMap).forEach((cls) => d.classList.remove(cls));
          d.classList.add(fontMap[font] || fontMap[defaultFont]);
        }

        // Apply
        const theme = localStorage.getItem(themeKey) || defaultTheme;
        const font = localStorage.getItem(fontKey) || defaultFont;
        applyTheme(theme);
        applyFont(font);

        // System theme listener
        if (theme === 'system') {
          darkQuery.addEventListener('change', (e) => {
            if ((localStorage.getItem(themeKey) || defaultTheme) === 'system') {
              d.classList.toggle('dark', e.matches);
            }
          });
        }
      })();
    </script>
  </head>

  <body class="flex flex-col items-center p-5 sm:p-12 lg:p-20 text-text/70 bg-bg">
    <Header />
    <div class="flex flex-wrap gap-20 w-full bg-bg">
      <Aside class="top-20 2xl:sticky" dim={isDim} transition:persist="aside" />
      <div class="max-w-full w-[80ch]">
        <main class:list={[classList]}>
          <slot />
        </main>
      </div>
    </div>
    <Footer />
  </body>
</html>
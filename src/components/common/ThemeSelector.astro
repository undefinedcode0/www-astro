---
import { Moon, Sun, Monitor } from 'astro-feather-icons2';

// No server-side logic needed here anymore

const themes = [
  { name: 'system', icon: Monitor },
  { name: 'light', icon: Sun },
  { name: 'dark', icon: Moon },
];
---

<div id="theme-selector" class="flex p-1 space-x-1 rounded-xl shadow-md bg-text/10 w-fit">
  {
    themes.map(({ name, icon: Icon }) => (
      <button
        data-theme={name}
        title={`Set theme to ${name}`}
        class:list={[
          'theme-button inline-grid place-items-center text-text aspect-square size-8 smooth-md rounded-lg',
          // Initial active state (e.g., 'bg-bg') will be added by the script below
        ]}>
        <Icon size="16" />
      </button>
    ))
  }
</div>

<script is:inline>
  const themeStorageKey = 'theme';
  const themeQuery = '(prefers-color-scheme: dark)';
  const defaultTheme = 'system';
  const mediaQuery = window.matchMedia(themeQuery);

  function getStoredTheme() {
    return localStorage.getItem(themeStorageKey) || defaultTheme;
  }

  function applyThemePreference(theme) {
    const d = document.documentElement;
    d.classList.remove('dark', 'light', 'system');

    if (theme === 'dark') {
      d.classList.add('dark');
      return;
    }

    if (theme === 'light') {
      d.classList.add('light');
      return;
    }

    // system
    d.classList.add('system');
    if (mediaQuery.matches) d.classList.add('dark');
  }

  function updateButtons(selectedTheme) {
    document.querySelectorAll('#theme-selector .theme-button').forEach((button) => {
      const buttonTheme = button.getAttribute('data-theme');
      const isActive = buttonTheme === selectedTheme;
      button.classList.toggle('bg-bg', isActive);
      button.classList.toggle('hover:bg-text/10', !isActive);
    });
  }

  const handleSystemThemeChange = (e) => {
    if (getStoredTheme() !== 'system') return;
    const d = document.documentElement;
    if (e.matches) d.classList.add('dark');
    else d.classList.remove('dark');
  };

  function setTheme(newTheme) {
    localStorage.setItem(themeStorageKey, newTheme);
    applyThemePreference(newTheme);
    updateButtons(newTheme);

    mediaQuery.removeEventListener('change', handleSystemThemeChange);
    if (newTheme === 'system') mediaQuery.addEventListener('change', handleSystemThemeChange);
  }

  function initThemeSelector() {
    const root = document.getElementById('theme-selector');
    if (!root) return;

    // bind once via property (overwrites on re-init, does not stack)
    root.onclick = (e) => {
      const btn = e.target.closest?.('button[data-theme]');
      if (!btn) return;
      const newTheme = btn.getAttribute('data-theme');
      if (newTheme) setTheme(newTheme);
    };

    const current = getStoredTheme();
    updateButtons(current);

    mediaQuery.removeEventListener('change', handleSystemThemeChange);
    if (current === 'system') mediaQuery.addEventListener('change', handleSystemThemeChange);
  }

  initThemeSelector();
  document.addEventListener('astro:page-load', initThemeSelector);
</script>

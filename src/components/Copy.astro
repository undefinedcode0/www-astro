---
interface Props {
  text: string;
  class?: string;
}

const { text, class: className } = Astro.props;
---

<span
  role="button"
  tabindex="0"
  aria-label="Copy text to clipboard"
  class:list={['copy-wrapper inline-flex items-center cursor-pointer group relative text-link', className]}
  data-copy-text={text}>
  <slot />
  <span class="copy-icon inline-flex items-center ml-1 opacity-0 scale-75 transition-all duration-200">
    <svg
      class="copy-symbol"
      xmlns="http://www.w3.org/2000/svg"
      width="14"
      height="14"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      aria-hidden="true">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
    </svg>
    <svg
      class="checkmark hidden"
      xmlns="http://www.w3.org/2000/svg"
      width="14"
      height="14"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      aria-hidden="true">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
  </span>
</span>

<style>
  .copy-icon {
    transform-origin: center;
    pointer-events: none;
  }
  .copy-wrapper:hover .copy-icon:not(.copied),
  .copy-wrapper:focus .copy-icon:not(.copied) {
    opacity: 1;
    transform: scale(1);
  }
  .copy-icon.copied {
    opacity: 1;
    transform: scale(1);
  }
</style>

<script>
  const copyHandler = async (e) => {
    const el = e.target?.closest?.('.copy-wrapper');
    if (!el) return;

    const text = el.getAttribute('data-copy-text');
    if (!text) return;

    const icon = el.querySelector('.copy-icon');
    const copySymbol = el.querySelector('.copy-symbol');
    const checkmark = el.querySelector('.checkmark');

    try {
      await navigator.clipboard.writeText(text);

      if (icon && copySymbol && checkmark) {
        icon.classList.add('copied');
        copySymbol.classList.add('hidden');
        checkmark.classList.remove('hidden');

        setTimeout(() => {
          icon.classList.remove('copied');
          copySymbol.classList.remove('hidden');
          checkmark.classList.add('hidden');
        }, 2000);
      }
    } catch (err) {
      // Fallback for older browsers
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.cssText = 'position:fixed;left:-9999px';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
    }
  };

  function initCopyHandlers() {
    document.removeEventListener('click', copyHandler);
    document.addEventListener('click', copyHandler);
  }

  initCopyHandlers();
  document.addEventListener('astro:page-load', initCopyHandlers);
</script>

---
const { autoplay = false, interval = 5000, showArrows = true, showDots = true, rounded = '2xl' } = Astro.props;
const slideshowId = `slideshow-${Math.random().toString(36).slice(2, 9)}`;
---

<div
  id={slideshowId}
  class={`slideshow relative w-full rounded-${rounded}`}
  data-autoplay={autoplay}
  data-interval={interval}
  role="region"
  aria-roledescription="carousel">
  <div class="overflow-hidden w-full">
    <div class="slides flex transition-transform duration-500 ease-out will-change-transform">
      <slot />
    </div>
  </div>

  {
    showArrows && (
      <div class="pointer-events-none absolute inset-y-0 left-0 right-0 flex items-center justify-between px-3">
        <button
          type="button"
          class="prev pointer-events-auto inline-flex items-center justify-center rounded-md p-2 text-sm bg-text/10 hover:bg-text/20 text-text/90 focus:outline-none focus:ring-2 focus:ring-text/20"
          aria-label="Previous slide">
          ‹
        </button>
        <button
          type="button"
          class="next pointer-events-auto inline-flex items-center justify-center rounded-md p-2 text-sm bg-text/10 hover:bg-text/20 text-text/90 focus:outline-none focus:ring-2 focus:ring-text/20"
          aria-label="Next slide">
          ›
        </button>
      </div>
    )
  }

  {showDots && <div class="dots absolute left-1/2 bottom-3 -translate-x-1/2 flex gap-2" aria-hidden="false" />}
</div>

<script>
  const slideshowInstances = new WeakMap<Element, { cleanup: () => void }>();

  function initSlideshow(container: Element) {
    // Cleanup existing instance
    slideshowInstances.get(container)?.cleanup();

    const slidesWrap = container.querySelector('.slides') as HTMLElement;
    if (!slidesWrap) return;

    // Wrap children once
    Array.from(slidesWrap.children).forEach((child) => {
      if (child.classList.contains('slide')) return;
      const wrapper = document.createElement('div');
      wrapper.className = 'slide min-w-full flex items-center justify-center';
      child.replaceWith(wrapper);
      wrapper.appendChild(child);

      const img = wrapper.querySelector('img');
      if (img) img.classList.add('w-full', 'h-auto', 'object-contain', 'max-h-[70vh]');
    });

    const slides = slidesWrap.querySelectorAll('.slide');
    const total = slides.length;
    if (!total) return;

    let idx = 0;
    let intervalId: number | null = null;
    const abortController = new AbortController();
    const { signal } = abortController;

    const update = (i: number) => {
      slidesWrap.style.transform = `translateX(-${i * 100}%)`;
      container.querySelectorAll('.dot').forEach((d, j) => {
        d.classList.toggle('bg-text', j === i);
        d.classList.toggle('bg-text/30', j !== i);
      });
    };

    // Dots
    const dotsContainer = container.querySelector('.dots');
    if (dotsContainer) {
      dotsContainer.innerHTML = '';
      const fragment = document.createDocumentFragment();
      for (let i = 0; i < total; i++) {
        const d = document.createElement('button');
        d.type = 'button';
        d.className = 'dot w-2 h-2 rounded-full bg-text/30';
        d.setAttribute('aria-label', `Go to slide ${i + 1}`);
        d.addEventListener(
          'click',
          () => {
            idx = i;
            update(idx);
          },
          { signal },
        );
        fragment.appendChild(d);
      }
      dotsContainer.appendChild(fragment);
    }

    // Navigation
    const prev = () => {
      idx = (idx - 1 + total) % total;
      update(idx);
    };
    const next = () => {
      idx = (idx + 1) % total;
      update(idx);
    };

    container.querySelector('.prev')?.addEventListener('click', prev, { signal });
    container.querySelector('.next')?.addEventListener('click', next, { signal });

    // Keyboard
    container.addEventListener(
      'keydown',
      (e) => {
        if ((e as KeyboardEvent).key === 'ArrowLeft') prev();
        if ((e as KeyboardEvent).key === 'ArrowRight') next();
      },
      { signal },
    );

    // Touch
    let startX: number | null = null;
    slidesWrap.addEventListener(
      'touchstart',
      (e) => {
        startX = (e as TouchEvent).touches[0].clientX;
      },
      { passive: true, signal },
    );
    slidesWrap.addEventListener(
      'touchend',
      (e) => {
        if (startX === null) return;
        const diff = startX - (e as TouchEvent).changedTouches[0].clientX;
        if (Math.abs(diff) > 30) diff > 0 ? next() : prev();
        startX = null;
      },
      { signal },
    );

    // Autoplay
    const isAutoplay = container.getAttribute('data-autoplay') === 'true';
    const ms = parseInt(container.getAttribute('data-interval') || '5000', 10);

    const startAutoplay = () => {
      if (isAutoplay && !intervalId) {
        intervalId = window.setInterval(next, ms);
      }
    };
    const stopAutoplay = () => {
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
    };

    if (isAutoplay) {
      startAutoplay();
      container.addEventListener('mouseenter', stopAutoplay, { signal });
      container.addEventListener('mouseleave', startAutoplay, { signal });
    }

    update(idx);

    // Store cleanup function
    slideshowInstances.set(container, {
      cleanup: () => {
        abortController.abort();
        stopAutoplay();
      },
    });
  }

  function initAll() {
    document.querySelectorAll('.slideshow').forEach(initSlideshow);
  }

  initAll();
  document.addEventListener('astro:page-load', initAll);
  document.addEventListener('astro:before-swap', () => {
    document.querySelectorAll('.slideshow').forEach((el) => {
      slideshowInstances.get(el)?.cleanup();
    });
  });
</script>
